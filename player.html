<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player | PEGASUS</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .loading-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 400px;
      background: var(--card-bg);
      color: var(--text-secondary);
      border-radius: 8px;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.1);
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .play-button-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 5rem;
      opacity: 0.8;
      transition: opacity 0.3s ease;
      cursor: pointer;
    }
    
    .play-button-overlay:hover {
      opacity: 1;
    }
    
    .btn.active {
      background: var(--success);
      color: white;
    }

    /* Video player enhancements */
    .video-player {
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
      position: relative;
      background: #000;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    
    .video-player > * {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Ensure all common video embed types are responsive */
    .video-player iframe,
    .video-player video,
    .video-player object,
    .video-player embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Thumbnail fallback styling */
    .thumbnail-fallback {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .thumbnail-fallback img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Player controls */
    .player-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .video-player:hover .player-controls {
      opacity: 1;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    
    .control-btn:hover {
      opacity: 1;
    }
    
    .progress-bar {
      flex-grow: 1;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      margin: 0 15px;
      position: relative;
      cursor: pointer;
    }
    
    .progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      width: 0%;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <nav class="navbar">
        <a href="index.html" class="logo">
          <img src="images/pegasus-logo.png" alt="PEGASUS Logo">PEGASUS
        </a>
        
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="live-stream.html">Live</a></li>
          <li><a href="video-on-demand.html">VOD</a></li>
          <li><a href="highlights.html">Highlights</a></li>
          <li><a href="channels.html">Channels</a></li>
          
          <!-- Mobile Auth Buttons (Hidden on Desktop) -->
          <li class="mobile-auth-item">
            <div class="mobile-auth">
              <a href="#" class="btn btn-outline">Sign In</a>
              <a href="#" class="btn">Subscribe</a>
            </div>
          </li>
        </ul>
        
        <!-- Desktop Auth Buttons (Hidden on Mobile) -->
        <div class="auth-buttons">
          <a href="#" class="btn btn-outline">Sign In</a>
          <a href="#" class="btn">Subscribe</a>
        </div>
        
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </nav>
    </div>
  </header>

  <!-- Player Section -->
  <section class="player-container">
    <div class="container">
      <div class="player-wrapper">
        <div class="video-player" id="video-player">
          <div class="loading-placeholder">
            <div class="loading-spinner"></div>
            <p>Loading content...</p>
          </div>
          <!-- Player controls will be added dynamically -->
        </div>
        
        <div class="player-info">
          <h1 id="player-title">Loading content...</h1>
          <div class="player-meta">
            <span id="player-views">0 views</span>
            <span id="player-date"></span>
          </div>
          <p id="player-description">Content description will appear here.</p>
          
          <div class="player-actions">
            <button class="btn" id="share-btn">Share</button>
            <button class="btn btn-outline" id="favorite-btn">Add to Favorites</button>
          </div>
        </div>
      </div>
      
      <!-- Ad Section -->
      <div class="ad-container">
        <h3>Advertisement</h3>
        <div class="ad-placeholder">
          Ad content would be displayed here
        </div>
      </div>
      
      <!-- Related Content -->
      <h2 class="section-title">Related Content</h2>
      <div class="stream-grid" id="related-content">
        <!-- Related content will be loaded here -->
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-column">
          <h3>PEGASUS</h3>
          <p>The ultimate sports streaming platform with live events, on-demand content, and exclusive coverage.</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
        
        <div class="footer-column">
          <h3>Navigation</h3>
          <ul class="footer-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="live-stream.html">Live Streams</a></li>
            <li><a href="video-on-demand.html">Video On Demand</a></li>
            <li><a href="highlights.html">Highlights</a></li>
            <li><a href="channels.html">Channels</a></li>
          </ul>
        </div>
        
        <div class="footer-column">
          <h3>Legal</h3>
          <ul class="footer-links">
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="dmca.html">DMCA Policy</a></li>
            <li><a href="cookie.html">Cookie Policy</a></li>
          </ul>
        </div>
        
        <div class="footer-column">
          <h3>Support</h3>
          <ul class="footer-links">
            <li><a href="about.html">About Us</a></li>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="faq.html">FAQs</a></li>
            <li><a href="help.html">Help Center</a></li>
          </ul>
        </div>
      </div>
      
      <div class="copyright">
        &copy; 2023 PEGASUS Sports Streaming. All rights reserved.
      </div>
    </div>
  </footer>

  <script>
    // API base URL
    const API_BASE = 'https://pegasus-backend.super-elmore95.workers.dev';
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const contentType = urlParams.get('type');
    const contentId = urlParams.get('id');
    
    // Function to load player content
    async function loadPlayerContent() {
      try {
        console.log('Loading player content for:', contentType, contentId);
        
        // First, try to get all content
        const response = await fetch(`${API_BASE}/api/content`);
        const allContent = await response.json();
        
        let content = null;
        let contentArray = null;
        
        // Find the specific content based on type and ID
        if (contentType && contentId) {
          if (contentType === 'live') {
            contentArray = allContent.live;
          } else if (contentType === 'vod') {
            contentArray = allContent.vod;
          } else if (contentType === 'highlight') {
            contentArray = allContent.highlights;
          }
          
          if (contentArray) {
            content = contentArray.find(item => item.id == contentId);
          }
        }
        
        if (content) {
          updatePlayer(content);
          loadRelatedContent(content.category, contentId);
        } else {
          // If no specific content found, show a message
          document.getElementById('player-title').textContent = 'Content not found';
          document.getElementById('player-description').textContent = 'The requested content could not be found.';
          
          // Load some related content anyway
          loadRelatedContent('sports');
        }
      } catch (error) {
        console.error('Error loading player content:', error);
        document.getElementById('player-title').textContent = 'Error loading content';
        document.getElementById('player-description').textContent = 'There was an error loading the content. Please try again later.';
      }
    }
    
    // Function to update player with content
    function updatePlayer(content) {
      console.log('Updating player with content:', content);
      
      // Update title
      document.getElementById('player-title').textContent = content.title;
      
      // Update description
      if (content.description) {
        document.getElementById('player-description').textContent = content.description;
      }
      
      // Update views
      if (content.views_count !== undefined) {
        document.getElementById('player-views').textContent = `${content.views_count.toLocaleString()} views`;
      } else if (content.viewers_count !== undefined) {
        document.getElementById('player-views').textContent = `${content.viewers_count.toLocaleString()} watching`;
      }
      
      // Update date
      if (content.created_at) {
        const date = new Date(content.created_at);
        document.getElementById('player-date').textContent = date.toLocaleDateString();
      }
      
      // Update embed code
      const videoPlayer = document.getElementById('video-player');
      
      // Clear previous content
      videoPlayer.innerHTML = '';
      
      if (content.embed_code) {
        // Create wrapper for embed code
        const embedWrapper = document.createElement('div');
        embedWrapper.innerHTML = content.embed_code;
        
        // Make all embedded content responsive
        const iframes = embedWrapper.querySelectorAll('iframe');
        iframes.forEach(iframe => {
          iframe.style.position = 'absolute';
          iframe.style.top = '0';
          iframe.style.left = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
        });
        
        // Also handle video tags
        const videos = embedWrapper.querySelectorAll('video');
        videos.forEach(video => {
          video.style.position = 'absolute';
          video.style.top = '0';
          video.style.left = '0';
          video.style.width = '100%';
          video.style.height = '100%';
          video.setAttribute('controls', 'true');
        });
        
        videoPlayer.appendChild(embedWrapper);
      } else if (content.thumbnail) {
        // Fallback to thumbnail if no embed code
        videoPlayer.innerHTML = `
          <div class="thumbnail-fallback">
            <img src="${content.thumbnail}" alt="${content.title}">
            <div class="play-button-overlay">
              <i class="fas fa-play-circle"></i>
            </div>
          </div>
        `;
      } else {
        // Show error if no content available
        videoPlayer.innerHTML = `
          <div class="loading-placeholder">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
            <p>Content unavailable</p>
          </div>
        `;
      }
      
      // Update page title
      document.title = `${content.title} - PEGASUS`;
    }
    
    // Function to load related content
    async function loadRelatedContent(category, excludeId) {
      try {
        const response = await fetch(`${API_BASE}/api/content`);
        const content = await response.json();
        
        let relatedContent = [];
        
        // Get content from all types that matches the category
        if (content.live) {
          relatedContent = relatedContent.concat(
            content.live.filter(item => item.category === category && item.id != excludeId)
          );
        }
        
        if (content.vod) {
          relatedContent = relatedContent.concat(
            content.vod.filter(item => item.category === category && item.id != excludeId)
          );
        }
        
        if (content.highlights) {
          relatedContent = relatedContent.concat(
            content.highlights.filter(item => item.category === category && item.id != excludeId)
          );
        }
        
        // If no category-specific content, get any content
        if (relatedContent.length === 0) {
          if (content.live) relatedContent = relatedContent.concat(content.live);
          if (content.vod) relatedContent = relatedContent.concat(content.vod);
          if (content.highlights) relatedContent = relatedContent.concat(content.highlights);
        }
        
        // Remove the excluded item and limit to 4 items
        relatedContent = relatedContent
          .filter(item => item.id != excludeId)
          .slice(0, 4);
        
        // Update the related content section
        const relatedContainer = document.getElementById('related-content');
        
        if (relatedContent.length > 0) {
          relatedContainer.innerHTML = relatedContent.map(item => {
            const isLive = item.is_live || false;
            const type = isLive ? 'live' : 'vod';
            return `
              <a href="player.html?type=${type}&id=${item.id}" class="stream-card">
                <div class="card-img">
                  <img src="${item.thumbnail || 'https://via.placeholder.com/400x225'}" alt="${item.title}" onerror="this.src='https://via.placeholder.com/400x225'">
                  ${isLive ? '<div class="live-badge">LIVE</div>' : ''}
                </div>
                <div class="card-content">
                  <h3 class="card-title">${item.title}</h3>
                  <div class="card-meta">
                    <span>${item.category || 'Sports'}</span>
                    <span class="card-views">${item.views_count || item.viewers_count || 0} ${isLive ? 'watching' : 'views'}</span>
                  </div>
                </div>
              </a>
            `;
          }).join('');
        } else {
          relatedContainer.innerHTML = '<p>No related content found.</p>';
        }
      } catch (error) {
        console.error('Error loading related content:', error);
        document.getElementById('related-content').innerHTML = '<p>Error loading related content.</p>';
      }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Player page initialized');
      
      // Initialize mobile menu
      const hamburger = document.querySelector('.hamburger');
      const navLinks = document.querySelector('.nav-links');
      
      if (hamburger && navLinks) {
        hamburger.addEventListener('click', () => {
          hamburger.classList.toggle('active');
          navLinks.classList.toggle('active');
        });
      }
      
      // Load player content
      loadPlayerContent();
      
      // Set up share button
      document.getElementById('share-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (navigator.share) {
          navigator.share({
            title: document.title,
            url: window.location.href
          }).catch(console.error);
        } else {
          alert('Share feature not available in your browser. Copy this URL: ' + window.location.href);
        }
      });
      
      // Set up favorite button
      document.getElementById('favorite-btn').addEventListener('click', function(e) {
        e.preventDefault();
        this.classList.toggle('active');
        if (this.classList.contains('active')) {
          this.textContent = 'Remove from Favorites';
        } else {
          this.textContent = 'Add to Favorites';
        }
      });
    });
  </script>
</body>
</html>
