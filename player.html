<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PEGASUS - Player</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="player-page">
  <!-- Preloader -->
  <div id="preloader">
    <div class="preloader-content">
      <img src="images/pegasus-logo.png" alt="PEGASUS Logo" class="preloader-logo">
      <div class="loading-circle"></div>
    </div>
  </div>

  <!-- Player Container -->
  <div class="player-container" id="player-container">
    <div class="player-wrapper">
      <div class="video-player" id="video-player">
        <div class="loading-placeholder">
          <div class="loading-spinner"></div>
          <p>Loading content...</p>
        </div>
      </div>
      
      <div class="player-controls">
        <h1 class="player-title" id="player-title">Content Title</h1>
        <div class="player-meta">
          <span id="player-status">Loading...</span>
          <span id="player-viewers">0 viewers</span>
        </div>
        <div class="player-actions">
          <button class="btn" id="favorite-btn">
            <i class="far fa-heart"></i> Favorite
          </button>
          <button class="btn btn-outline" id="share-btn">
            <i class="fas fa-share-alt"></i> Share
          </button>
          <button class="btn btn-outline" id="download-btn" style="display: none;">
            <i class="fas fa-download"></i> Download
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Player Info and Related Content -->
  <div class="player-info">
    <p class="player-description" id="player-description">Content description will appear here.</p>
    
    <!-- Comments Section (only for VOD and highlights) -->
    <div class="comments-section" id="comments-section" style="display: none;">
      <h3>Comments</h3>
      <div id="comment-form-container">
        <!-- Will be populated by JavaScript based on auth status -->
      </div>
      <div class="comment-list" id="comment-list">
        <!-- Comments will be loaded here -->
      </div>
    </div>
    
    <!-- Related Content -->
    <section class="section">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">Related Content</h2>
        </div>
        
        <div class="related-tabs">
          <button class="related-tab active" data-type="all">All</button>
          <button class="related-tab" data-type="live">Live Streams</button>
          <button class="related-tab" data-type="vod">VOD</button>
          <button class="related-tab" data-type="highlight">Highlights</button>
        </div>
        
        <div class="stream-grid" id="related-content">
          <div class="loading-placeholder">
            <div class="loading-spinner"></div>
            <p>Loading related content...</p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Ad Container -->
    <div class="container">
      <div class="ad-container">
        <h3>Premium Subscription</h3>
        <p>Upgrade to unlock all content without ads and access exclusive features</p>
        <div class="ad-placeholder">
          <a href="signup.html" class="btn">Subscribe Now</a>
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Enhanced player functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize auth manager
      if (!window.authManager) {
        console.error('Auth manager not initialized');
        return;
      }
      
      // Get parameters from URL
      const urlParams = new URLSearchParams(window.location.search);
      const type = urlParams.get('type');
      const id = urlParams.get('id');
      
      if (!type || !id) {
        showError('Missing content parameters');
        return;
      }
      
      // Global variables to store current content info
      window.currentContentId = id;
      window.currentContentType = type;
      window.currentFavoriteId = null;
      
      // Load player content
      loadPlayerContent(type, id);
      
      // Check if comments should be shown (for VOD and highlights only)
      if (type === 'vod' || type === 'highlight') {
        document.getElementById('comments-section').style.display = 'block';
        loadComments();
        setupCommentForm();
      }
      
      // Set up event listeners
      document.getElementById('share-btn').addEventListener('click', handleShare);
      document.getElementById('favorite-btn').addEventListener('click', toggleFavorite);
      document.getElementById('download-btn').addEventListener('click', handleDownload);
      
      // Set up related content tabs
      const relatedTabs = document.querySelectorAll('.related-tab');
      relatedTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab
          relatedTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Filter content
          const type = this.getAttribute('data-type');
          filterRelatedContent(type);
        });
      });
    });
    
    // Function to load player content
    async function loadPlayerContent(type, id) {
      try {
        const API_BASE = window.PEGASUS_CONFIG ? window.PEGASUS_CONFIG.API_BASE : 'https://pegasus-backend.super-elmore95.workers.dev';
        
        const token = window.authManager ? window.authManager.getToken() : null;
        const headers = {
          'Content-Type': 'application/json'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        // Load content from API
        const response = await fetch(`${API_BASE}/api/content/${type}/${id}`, { headers });
        
        if (!response.ok) {
          if (response.status === 401) {
            // Not authenticated - show message
            showError('Please sign in to access this content');
            return;
          } else if (response.status === 403) {
            // Not authorized - premium content
            showError('Premium subscription required');
            return;
          } else {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
        }
        
        const content = await response.json();
        
        // Update the page with the content
        updatePlayerContent(content, type);
        
        // Load related content
        loadRelatedContent(type);
        
        // Check favorite status if user is logged in
        if (window.authManager && window.authManager.isAuthenticated()) {
          checkFavoriteStatus();
        }
        
        // Hide preloader
        hidePreloader();
        
      } catch (error) {
        console.error('Error loading player content:', error);
        showError('Failed to load content: ' + error.message);
      }
    }
    
    // Function to update the player with content
    function updatePlayerContent(content, type) {
      // Update page title
      document.title = `${content.title || content.name} | PEGASUS`;
      
      // Update player title
      document.getElementById('player-title').textContent = content.title || content.name;
      
      // Update player description if available
      if (content.description) {
        document.getElementById('player-description').textContent = content.description;
      }
      
      // Update player metadata
      if (type === 'live' || (type === 'channel' && content.is_live)) {
        document.getElementById('player-status').textContent = 'Live';
        document.getElementById('player-viewers').textContent = `${content.viewers_count || 0} watching`;
      } else {
        document.getElementById('player-status').textContent = 'On Demand';
        document.getElementById('player-viewers').textContent = `${content.views_count || content.view_count || 0} views`;
      }
      
      // Update video player
      const videoPlayer = document.getElementById('video-player');
      
      // Clear previous content
      videoPlayer.innerHTML = '';
      
      // Add content type badge
      const typeBadge = document.createElement('div');
      typeBadge.className = `content-type-badge content-type-${type}`;
      typeBadge.textContent = type.toUpperCase();
      videoPlayer.appendChild(typeBadge);
      
      if (content.embed_code) {
        // Create wrapper for embed code
        const embedWrapper = document.createElement('div');
        embedWrapper.style.position = 'absolute';
        embedWrapper.style.top = '0';
        embedWrapper.style.left = '0';
        embedWrapper.style.width = '100%';
        embedWrapper.style.height = '100%';
        embedWrapper.innerHTML = content.embed_code;
        
        // Make all embedded content responsive
        const iframes = embedWrapper.querySelectorAll('iframe');
        iframes.forEach(iframe => {
          iframe.style.position = 'absolute';
          iframe.style.top = '0';
          iframe.style.left = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
        });
        
        // Also handle video tags
        const videos = embedWrapper.querySelectorAll('video');
        videos.forEach(video => {
          video.style.position = 'absolute';
          video.style.top = '0';
          video.style.left = '0';
          video.style.width = '100%';
          video.style.height = '100%';
          video.setAttribute('controls', 'true');
          video.setAttribute('autoplay', 'true');
        });
        
        videoPlayer.appendChild(embedWrapper);
      } else if (content.thumbnail || content.thumbnail_url) {
        // Fallback to thumbnail if no embed code
        videoPlayer.innerHTML = `
          <div class="thumbnail-fallback">
            <img src="${content.thumbnail || content.thumbnail_url}" alt="${content.title || content.name}" onerror="this.src='https://via.placeholder.com/400x225'">
            <div class="play-button-overlay">
              <i class="fas fa-play-circle"></i>
            </div>
          </div>
        `;
      } else {
        // Show error if no content available
        videoPlayer.innerHTML = `
          <div class="loading-placeholder">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
            <p>Content unavailable</p>
          </div>
        `;
      }
      
      // Show/hide download button based on content type
      const downloadBtn = document.getElementById('download-btn');
      if (type === 'vod' || type === 'highlight') {
        downloadBtn.style.display = 'inline-block';
      } else {
        downloadBtn.style.display = 'none';
      }
    }
    
    // Function to load related content
    async function loadRelatedContent(type) {
      const relatedContainer = document.getElementById('related-content');
      
      try {
        const API_BASE = window.PEGASUS_CONFIG ? window.PEGASUS_CONFIG.API_BASE : 'https://pegasus-backend.super-elmore95.workers.dev';
        
        const token = window.authManager ? window.authManager.getToken() : null;
        const headers = {
          'Content-Type': 'application/json'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        // Load all content to filter for related items
        const response = await fetch(`${API_BASE}/api/content`, { headers });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const content = await response.json();
        
        // Store all content for filtering
        window.allRelatedContent = [];
        
        // Combine all content types
        if (content.live) window.allRelatedContent = window.allRelatedContent.concat(content.live);
        if (content.vod) window.allRelatedContent = window.allRelatedContent.concat(content.vod);
        if (content.highlights) window.allRelatedContent = window.allRelatedContent.concat(content.highlights);
        if (content.channels) window.allRelatedContent = window.allRelatedContent.concat(content.channels);
        
        // Filter out current content
        window.allRelatedContent = window.allRelatedContent.filter(item => 
          item.id != window.currentContentId
        );
        
        // Show initial related content
        filterRelatedContent('all');
        
      } catch (error) {
        console.error('Error loading related content:', error);
        relatedContainer.innerHTML = '<p class="no-content">Failed to load related content</p>';
      }
    }
    
    // Function to filter related content by type
    function filterRelatedContent(type) {
      const relatedContainer = document.getElementById('related-content');
      
      if (!window.allRelatedContent || window.allRelatedContent.length === 0) {
        relatedContainer.innerHTML = '<p class="no-content">No related content found.</p>';
        return;
      }
      
      let filteredContent = window.allRelatedContent;
      
      if (type !== 'all') {
        filteredContent = window.allRelatedContent.filter(item => {
          if (type === 'live') return item.is_live;
          if (type === 'vod') return !item.is_live && item.type !== 'highlight';
          if (type === 'highlight') return item.type === 'highlight';
          return true;
        });
      }
      
      if (filteredContent.length > 0) {
        relatedContainer.innerHTML = filteredContent.map(item => {
          const isLive = item.is_live || false;
          const itemType = isLive ? 'live' : (item.type || 'vod');
          return `
            <a href="player.html?type=${itemType}&id=${item.id}" class="stream-card">
              <div class="card-img">
                <img src="${item.thumbnail || item.thumbnail_url || 'https://via.placeholder.com/400x225'}" 
                     alt="${item.title || item.name}" 
                     onerror="this.src='https://via.placeholder.com/400x225'">
                ${isLive ? '<div class="live-badge">LIVE</div>' : ''}
                ${item.requires_premium ? '<div class="premium-badge">PREMIUM</div>' : ''}
                <div class="content-type-badge content-type-${itemType}">${itemType.toUpperCase()}</div>
                <div class="card-content">
                  <h3 class="card-title">${item.title || item.name}</h3>
                  <div class="card-meta">
                    <span>${item.category || 'Sports'}</span>
                    <span class="card-views">${item.views_count || item.viewers_count || 0} ${isLive ? 'watching' : 'views'}</span>
                  </div>
                </div>
              </div>
            </a>
          `;
        }).join('');
      } else {
        relatedContainer.innerHTML = '<p class="no-content">No related content found for this category.</p>';
      }
    }
    
    // Check if content is favorited
    async function checkFavoriteStatus() {
      if (!window.currentContentId || !window.currentContentType) return;
      
      try {
        const result = await window.authManager.checkFavoriteStatus(window.currentContentId, window.currentContentType);
        if (result.success) {
          window.currentFavoriteId = result.favoriteId;
          const favoriteBtn = document.getElementById('favorite-btn');
          if (favoriteBtn) {
            if (result.isFavorited) {
              favoriteBtn.classList.add('active');
              favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
            } else {
              favoriteBtn.classList.remove('active');
              favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
            }
          }
        }
      } catch (error) {
        console.error('Error checking favorite status:', error);
      }
    }
    
    // Toggle favorite status
    async function toggleFavorite() {
      if (!window.authManager || !window.authManager.isAuthenticated()) {
        alert('Please sign in to add favorites');
        window.location.href = 'signin.html?redirect=' + encodeURIComponent(window.location.href);
        return;
      }
      
      const favoriteBtn = document.getElementById('favorite-btn');
      if (!favoriteBtn) return;
      
      try {
        // Show loading state
        favoriteBtn.disabled = true;
        const originalHtml = favoriteBtn.innerHTML;
        favoriteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        if (window.currentFavoriteId) {
          // Remove from favorites
          const result = await window.authManager.removeFromFavorites(window.currentFavoriteId);
          if (result.success) {
            favoriteBtn.classList.remove('active');
            favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
            window.currentFavoriteId = null;
          } else {
            alert('Error: ' + result.error);
            favoriteBtn.innerHTML = originalHtml;
          }
        } else {
          // Add to favorites
          const result = await window.authManager.addToFavorites(window.currentContentId, window.currentContentType);
          if (result.success) {
            favoriteBtn.classList.add('active');
            favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
            window.currentFavoriteId = result.favoriteId;
          } else {
            alert('Error: ' + result.error);
            favoriteBtn.innerHTML = originalHtml;
          }
        }
      } catch (error) {
        console.error('Error toggling favorite:', error);
        alert('An error occurred. Please try again.');
        favoriteBtn.innerHTML = '<i class="far fa-heart'></i> Add to Favorites';
      } finally {
        favoriteBtn.disabled = false;
      }
    }
    
    // Handle share button click
    function handleShare() {
      if (navigator.share) {
        navigator.share({
          title: document.title,
          url: window.location.href
        }).catch(console.error);
      } else {
        // Fallback for browsers that don't support Web Share API
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('Link copied to clipboard!');
        }).catch(err => {
          alert('Share feature not available. Copy this URL: ' + window.location.href);
        });
      }
    }
    
    // Handle download button click
    function handleDownload() {
      alert('Download feature would be implemented here. This would vary based on your backend capabilities.');
    }
    
    // Load comments
    async function loadComments() {
      try {
        const result = await window.authManager.getComments(window.currentContentId, window.currentContentType);
        
        if (result.success) {
          displayComments(result.comments);
        } else {
          document.getElementById('comment-list').innerHTML = '<p>Failed to load comments</p>';
        }
      } catch (error) {
        console.error('Error loading comments:', error);
        document.getElementById('comment-list').innerHTML = '<p>Error loading comments</p>';
      }
    }
    
    // Display comments
    function displayComments(comments) {
      const commentList = document.getElementById('comment-list');
      
      if (!comments || comments.length === 0) {
        commentList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
        return;
      }
      
      commentList.innerHTML = comments.map(comment => `
        <div class="comment-item">
          <div>
            <span class="comment-author">${comment.user_name}</span>
            <span class="comment-time">${new Date(comment.created_at).toLocaleDateString()}</span>
          </div>
          <div class="comment-text">${comment.comment}</div>
        </div>
      `).join('');
    }
    
    // Setup comment form based on auth status
    function setupCommentForm() {
      const formContainer = document.getElementById('comment-form-container');
      
      if (window.authManager && window.authManager.isAuthenticated()) {
        formContainer.innerHTML = `
          <div class="comment-form">
            <textarea class="comment-input" id="comment-text" placeholder="Add a comment..." rows="3"></textarea>
            <button class="btn" id="submit-comment">Post Comment</button>
          </div>
        `;
        
        document.getElementById('submit-comment').addEventListener('click', submitComment);
      } else {
        formContainer.innerHTML = `
          <div class="login-prompt">
            <p>Please <a href="signin.html">sign in</a> to leave a comment</p>
          </div>
        `;
      }
    }
    
    // Submit comment
    async function submitComment() {
      try {
        const commentText = document.getElementById('comment-text').value.trim();
        if (!commentText) return;
        
        const result = await window.authManager.addComment(
          window.currentContentId, 
          window.currentContentType, 
          commentText
        );
        
        if (result.success) {
          document.getElementById('comment-text').value = '';
          loadComments(); // Reload comments
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('Error submitting comment:', error);
        alert('An error occurred. Please try again.');
      }
    }
    
    // Show error message
    function showError(message) {
      const videoPlayer = document.getElementById('video-player');
      videoPlayer.innerHTML = `
        <div class="loading-placeholder">
          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
          <p>${message}</p>
        </div>
      `;
      
      // Hide preloader
      hidePreloader();
    }
    
    // Hide preloader
    function hidePreloader() {
      setTimeout(() => {
        const preloader = document.getElementById('preloader');
        if (preloader) {
          preloader.classList.add('hide');
          setTimeout(() => {
            preloader.style.display = 'none';
          }, 500);
        }
      }, 500);
    }
  </script>
</body>
</html>
